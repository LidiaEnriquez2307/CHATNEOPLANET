-- DISPOSITIVO
delimiter //
use CHAT //

drop procedure if exists sp_insertar_dispositivo//
drop procedure if exists sp_mostrar_tokens//
drop procedure if exists sp_existe_token//

CREATE PROCEDURE sp_insertar_dispositivo(_codigoUnico text,_id_cuenta int,_token text) 
BEGIN
	IF((SELECT COUNT(*) FROM DISPOSITIVO WHERE codigoUnico = _codigoUnico)>0) THEN
		IF((SELECT id_cuenta FROM DISPOSITIVO WHERE codigoUnico = _codigoUnico)!=_id_cuenta) THEN
			UPDATE DISPOSITIVO SET id_cuenta=_id_cuenta WHERE codigoUnico=_codigoUnico;
		END IF;
		IF((SELECT token FROM DISPOSITIVO WHERE codigoUnico = _codigoUnico)!=_token) THEN
			UPDATE DISPOSITIVO SET token=_token WHERE codigoUnico=_codigoUnico;
		END IF;
	ELSEIF((SELECT COUNT(*) FROM DISPOSITIVO WHERE token = _token)=0) THEN
		INSERT INTO DISPOSITIVO(codigoUnico,id_cuenta,token) VALUES(_codigoUnico,_id_cuenta,_token);
	END IF;
END//

CREATE PROCEDURE sp_mostrar_tokens(_id_cuenta int, _id_sala int)
BEGIN
SELECT token FROM DISPOSITIVO as d 
INNER JOIN CUENTA as c on d.id_cuenta=c.id_cuenta
INNER JOIN CUENTA_SALA as cs on cs.id_cuenta=c.id_cuenta
INNER JOIN SALA as s on s.id_sala=cs.id_sala
WHERE s.id_sala=_id_sala AND c.id_cuenta!=_id_cuenta;
END
//
CREATE PROCEDURE sp_existe_token(_token text)
BEGIN
SELECT COUNT(*) FROM dispositivo WHERE token LIKE _token;
END
//