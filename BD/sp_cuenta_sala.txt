-- CUENTA_SALA
delimiter //
use CHAT//

drop procedure if exists sp_vincular_cuenta_sala//
drop procedure if exists sp_desvincular_cuenta_sala//
drop procedure if exists sp_salas_de_una_cuenta//

CREATE PROCEDURE sp_vincular_cuenta_sala(_id_cuenta int,_id_sala int,_administrador bool) 
BEGIN
	INSERT INTO CUENTA_SALA(id_cuenta,id_sala,fecha,administrador,activo) 
	VALUES(_id_cuenta,_id_sala,CURRENT_TIMESTAMP(),_administrador,true);
END//

CREATE PROCEDURE sp_desvincular_cuenta_sala(_id_sala_cuenta int) 
BEGIN
	UPDATE CUENTA_SALA SET administrador = false, activo = false 
	WHERE id_sala_cuenta= _id_sala_cuenta;
END//

CREATE PROCEDURE sp_salas_de_una_cuenta(_id_cuenta int) 
BEGIN
select s.id_sala,s.id_tipo_sala,if(ts.id_tipo_sala=2,(s.nombre),
          	(
            SELECT c.correo FROM CUENTA as c 
            INNER JOIN CUENTA_SALA as cs on c.id_cuenta = cs.id_cuenta 
            INNER JOIN SALA as sal on sal.id_sala=cs.id_sala 
            WHERE sal.id_sala=s.id_sala AND c.id_cuenta!=_id_cuenta
			)
         ) as nombre,s.fecha,s.activo from SALA as s 
INNER JOIN CUENTA_SALA as cs on s.id_sala = cs.id_sala 
INNER JOIN TIPO_SALA as ts on ts.id_tipo_sala=s.id_tipo_sala 
RIGHT JOIN CUENTA as c on c.id_cuenta = cs.id_cuenta 
WHERE cs.id_cuenta=_id_cuenta AND s.activo;
END//